<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trendify</title>
    <link rel="stylesheet" href="/styles/style.css" />
    <link rel="stylesheet" href="/styles/effects.css" />
    <link rel="stylesheet" href="/styles/price.css" />
    <link rel="icon" href="E-Commerce-logo.jpeg" type="image/x-icon" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <body style="background-color: seashell">
    <!-- Navbar 1 -->
    <nav
      class="navbar navbar-expand-lg"
      id="navbar1"
      style="background-color:rgb(209, 168, 123)"
    >
      <div class="container-fluid">
        <a class="navbar-brand" href="#" style="color: white" id="navbarBrand">
          <img
            id="title"
            src="/title1.png"
            alt=""
            style="height: 30px; width: 100px"
          />
        </a>

        <form
          id="SearchForm"
          class="d-flex mx-auto"
          role="search"
          action="/search"
          method="GET"
        >
          <input
            type="text"
            name="q"
            required
            class="form-control"
            type="search"
            placeholder="Search"
            aria-label="Search"
            style="background-color: white"
            id="searchInput"
          />
          <button
            class="btn btn-outline-dark"
            type="submit"
            style="
              background-color: rgb(240, 240, 240);
              padding: 0px;
              width: 40px;
            "
            id="searchButton"
          >
            <img
              src="https://static.vecteezy.com/system/resources/previews/016/716/177/original/search-3d-icon-png.png"
              style="
                object-fit: cover;
                width: 20px;
                height: 20px;
                margin: 0px;
                padding: 0px;
              "
            />
          </button>
        </form>
      </div>
    </nav>

    <nav
      class="navbar navbar-expand-lg"
      style="background-color: rgb(255, 209, 176)"
      id="navbar2"
    >
      <ul
        class="navbar-nav"
        style="display: flex; flex-direction: row; align-items: center"
      >
        <li class="nav-item">
          <a
            class="nav-link active"
            aria-current="page"
            href="/home"
            style="color: Black"
          >
            <img
              src="Home.png"
              style="object-fit: contain; width: 30px; height: 30px"
            />
          </a>
        </li>

        <li class="nav-item" id="nav-cart">
          <a class="nav-link active" aria-current="page" href="/cart" style="color: black; position: relative;">
            <img src="cart.png" style="object-fit: contain; width:30px; height: 30px;">
            <span class="cart-text">Cart</span>
            <span id="cart-count" 
      style="position: absolute; top: 0px; right: 0px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; display: none;">
</span>

          </a>
        </li>
        <li class="nav-item" id="nav-orders">
          <a
            class="nav-link active"
            aria-current="page"
            href="/my-orders"
            style="color: black"
          >
            <img
              src="Order.png"
              style="object-fit: contain; width: 30px; height: 30px"
            />
            <span class="cart-text">Orders</span>
          </a>
        </li>

        <li class="nav-item" id="SearchIcon">
          <a
            class="nav-link active"
            aria-current="page"
            href="/SearchProduct"
            style="color: black"
          >
            <img
              src="Search.png"
              style="object-fit: contain; width: 30px; height: 30px"
            />
          </a>
        </li>
      </ul>

      <div class="d-flex justify-content-end" style="position: fixed; right: 0">
        <div class="dropdown">
          <button class="d-flex align-items-center justify-content-center"
          id="Log_Button" type="button" data-bs-toggle="dropdown"
          aria-expanded="false" 
          style="background-color: white; width: 40px; height: 40px; border-radius: 50%; overflow: hidden; padding: 0; border: none;">
      <% if (username) { %>
          <span style="font-size: 18px; font-weight: bold; color: black;">
              <%= username.charAt(0).toUpperCase() %>
          </span>
      <% } else { %>
          <img id="Log_Buttonimage"
              src="https://static.vecteezy.com/system/resources/previews/000/550/731/original/user-icon-vector.jpg"
              alt="User Icon"
              style="width: 100%; height: 100%; object-fit: cover;" />
      <% } %>
  </button>

          <ul
            class="dropdown-menu dropdown-menu-end"
            style="background-color: rgb(226, 226, 226)"
          >
            <li class="nav-item" style="margin-top: 15px">
              <a
                class="nav-link"
                href="/signup"
                style="
                  color: black;
                  text-align: center;
                  font-size: 20px;
                  font-weight: bolder;
                "
                >Signup</a
              >
            </li>
            <li class="nav-item" style="margin-top: 15px">
              <a
                class="nav-link"
                href="/login"
                style="
                  color: black;
                  text-align: center;
                  font-size: 20px;
                  font-weight: bolder;
                "
                >Login</a
              >
            </li>
            <li class="nav-item" style="margin-top: 15px; margin-bottom: 15px">
              <a
                class="nav-link"
                href="/logout"
                style="
                  color: black;
                  text-align: center;
                  font-size: 20px;
                  font-weight: bolder;
                "
                >Logout</a
              >
            </li>
            <li class="nav-item" style="margin-top: 15px; margin-bottom: 15px">
              <a
                class="nav-link"
                href="/admin-Form"
                style="
                  color: black;
                  text-align: center;
                  font-size: 20px;
                  font-weight: bolder;
                "
                >Admin</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid p-2" id="ProductCard">
      <div class="row m-0">
        <% products.forEach(product => { %>
          <div class="col-12 p-0">
            <div class="card custom-card flex-md-row flex-column w-100">
              <div class="row m-0">
                <div class="col-md-3 col-12" id="productImage">
                  <img
                    src="<%= product.imageUrl %>"
                    class="img-fluid"
                    alt="Card image"
                    style="max-height: 200px; object-fit: contain"
                  />
                </div>
                <div class="col-md-9 col-12 p-2 custom-width">
                  <h3 class="card-title">
                    <a
                      href="/product/<%= product._id %>"
                      style="text-decoration: none; font-family: Arial, Helvetica, sans-serif;"
                    >
                      <%= product.title %>
                    </a>
                  </h3>
    
                  <!-- Show deal and delivery only if in stock -->
                  <% if (product.stock > 0) { %>
                    <div class="deal-card" data-price="<%= product.price %>">
                      <span class="deal-tag">Limited time deal</span>
                      <div class="price-container">
                        <span class="discount discount-percentage"></span>
                        <span class="final-price"></span>
                        <span class="original-price"></span>
                      </div>
                      
                      <p class="delivery-info">
                        Get it by <strong class="delivery-date"></strong>
                      </p>
                      <p class="delivery-method">FREE Delivery by Amazon</p>
                    </div>
                  <% } %>
    
                  <!-- Reviews Section -->
                  <% if (product.reviews.length > 0) { %>
                    <% 
                      // Find the best review (highest rating)
                      let bestReview = product.reviews.reduce((best, review) => 
                        review.rating > best.rating ? review : best, product.reviews[0]
                      );
                    %>
                    <p>
                      <strong>Rating:</strong> 
                      <% for (let i = 1; i <= 5; i++) { %>
                        <% if (i <= bestReview.rating) { %>
                          <i class="fas fa-star" style="color: gold;"></i> <!-- Filled star -->
                        <% } else { %>
                          <i class="far fa-star" style="color: lightgray;"></i> <!-- Empty star -->
                        <% } %>
                      <% } %>
                    </p>
                  <% } else { %>
                    <p>No reviews yet</p>
                  <% } %>
    
                  <!-- Buttons -->
                  <div class="btn-container">
                    <a
                      href="<% if (product.stock !== 0) { %>/place-order?product_id=<%= product._id %><% } else { %>#<% } %>"
                      class="btn <% if (product.stock !== 0) { %>btn-primary<% } else { %>btn-secondary<% } %>"
                      <% if (product.stock === 0) { %>disabled<% } %>
                    >
                      <% if (product.stock !== 0) { %>Buy Now<% } else { %>Unavailable<% } %>
                    </a>
    
                    <a
                      href="#"
                      class="btn btn-secondary"
                      onclick="addToCart('<%= product._id %>')"
                    >
                      Add to Cart
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% }); %>
      </div>
    </div>
    <div style="height: 500px"></div>
    
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let productCards = document.querySelectorAll(".deal-card");
    
        let today = new Date();
        let daySeed = today.getDate(); // Use the date to change discounts daily
    
        productCards.forEach((card, index) => {
          let actualPrice = parseFloat(card.getAttribute("data-price"));
    
          if (!isNaN(actualPrice) && actualPrice > 0) {
            // Generate a unique discount for each product (changes daily)
            let baseDiscount = ((index * 7 + daySeed) % 31) + 10; // Generates 10% - 40%
            let discountPercentage = Math.min(Math.max(baseDiscount, 10), 40); // Ensure it's within bounds
    
            // Generate fake original price variation based on actual price
            let priceVariation =
              actualPrice >= 1000
                ? Math.floor(Math.random() * (200 - 50 + 1)) + 50 // ₹50 - ₹200 for 1000+
                : actualPrice >= 100
                ? Math.floor(Math.random() * (20 - 5 + 1)) + 5 // ₹5 - ₹20 for 100 - 999
                : Math.floor(Math.random() * (5 - 1 + 1)) + 1; // ₹1 - ₹5 for < 100
    
            let updatedPrice = actualPrice + priceVariation;
    
            // Generate fake original price (inflated)
            let fakeIncreasePercentage =
              Math.floor(Math.random() * (30 - 10 + 1)) + 10; // 10% - 30%
            let increasedPrice = Math.round(
              updatedPrice * (1 + fakeIncreasePercentage / 100)
            );
    
            // Calculate delivery date (1 week from today)
            let deliveryDate = new Date(today);
            deliveryDate.setDate(today.getDate() + 7);
            let formattedDate = deliveryDate.toLocaleDateString("en-US", {
              weekday: "long",
              month: "long",
              day: "numeric",
            });
    
            // Format price display
            let formatPrice = (price) => `₹${price.toFixed(2)}`;
    
            // Update UI inside the specific product card
            card.querySelector(".original-price").innerText = formatPrice(increasedPrice);
            card.querySelector(".discount-percentage").innerText = `-${discountPercentage}%`;
            card.querySelector(".final-price").innerText = formatPrice(actualPrice);
            card.querySelector(".delivery-date").innerText = formattedDate;
          } else {
            console.error("Invalid product price:", actualPrice);
          }
        });
      });
    </script>
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        fetch('/cart/count')
          .then(res => res.json())
          .then(data => {
            updateCartBadge(data.totalItems || 0);
          })
          .catch(err => {
            console.error('Error fetching cart count:', err);
          });
      });
    
      function updateCartBadge(count) {
        const cartCountElem = document.getElementById('cart-count');
        if (!cartCountElem) return; // safety check
    
        if (count > 0) {
          cartCountElem.textContent = count;
          cartCountElem.style.display = 'inline';
        } else {
          cartCountElem.style.display = 'none';
        }
      }
    </script>
    
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="app.js"></script>
    <script src="custom.js"></script>
    <script src="effects.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="google-signin.js"></script>
    <script src="facebook-signin.js"></script>
    <script
      async
      defer
      crossorigin="anonymous"
      src="https://connect.facebook.net/en_US/sdk.js"
    ></script>
  </body>
</html>
